@model PayrollCreateViewModel
@{
    ViewData["Title"] = "Yeni Bordro Oluştur";
}

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-plus me-2"></i>Yeni Bordro Oluştur
                    </h4>
                </div>

                <div class="card-body">
                    <form asp-action="Create" method="post" id="payrollForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row">
                            <!-- Sol Kolon -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">Temel Bilgiler</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="PersonId" class="form-label">*</label>
                                            @Html.DropDownListFor(m => m.PersonId, ViewBag.PersonList as SelectList, "Personel Seçiniz", new { @class = "form-select", @required = "required" })
                                            <span asp-validation-for="PersonId" class="text-danger"></span>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Year" class="form-label">*</label>
                                                    <input asp-for="Year" class="form-control" type="number" min="2020" max="2030" required />
                                                    <span asp-validation-for="Year" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Month" class="form-label">*</label>
                                                    <select asp-for="Month" class="form-select" required>
                                                        <option value="">Ay Seçiniz</option>
                                                        <option value="1">Ocak</option>
                                                        <option value="2">Şubat</option>
                                                        <option value="3">Mart</option>
                                                        <option value="4">Nisan</option>
                                                        <option value="5">Mayıs</option>
                                                        <option value="6">Haziran</option>
                                                        <option value="7">Temmuz</option>
                                                        <option value="8">Ağustos</option>
                                                        <option value="9">Eylül</option>
                                                        <option value="10">Ekim</option>
                                                        <option value="11">Kasım</option>
                                                        <option value="12">Aralık</option>
                                                    </select>
                                                    <span asp-validation-for="Month" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="PreparedById" class="form-label"></label>
                                            @Html.DropDownListFor(m => m.PreparedById, ViewBag.PreparedByList as SelectList, "Hazırlayan Kişi Seçiniz", new { @class = "form-select" })
                                            <span asp-validation-for="PreparedById" class="text-danger"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="Description" class="form-label"></label>
                                            <textarea asp-for="Description" class="form-control" rows="3" placeholder="Bordro ile ilgili açıklama..."></textarea>
                                            <span asp-validation-for="Description" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sağ Kolon -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">Maaş Bilgileri</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="BasicSalary" class="form-label">*</label>
                                            <div class="input-group">
                                                <span class="input-group-text">₺</span>
                                                <input asp-for="BasicSalary" class="form-control text-end" type="number" step="0.01" min="0" max="999999" required id="basicSalary" />
                                            </div>
                                            <span asp-validation-for="BasicSalary" class="text-danger"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="Allowances" class="form-label"></label>
                                            <div class="input-group">
                                                <span class="input-group-text">₺</span>
                                                <input asp-for="Allowances" class="form-control text-end" type="number" step="0.01" min="0" max="999999" id="allowances" />
                                            </div>
                                            <span asp-validation-for="Allowances" class="text-danger"></span>
                                            <div class="form-text">Prim, ikramiye, ek ödeme vb.</div>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="Deductions" class="form-label"></label>
                                            <div class="input-group">
                                                <span class="input-group-text">₺</span>
                                                <input asp-for="Deductions" class="form-control text-end" type="number" step="0.01" min="0" max="999999" id="deductions" />
                                            </div>
                                            <span asp-validation-for="Deductions" class="text-danger"></span>
                                            <div class="form-text">Vergi, SGK, kesinti vb.</div>
                                        </div>

                                        <!-- Hesaplanan Değerler -->
                                        <div class="mt-4">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title">Hesaplanan Değerler</h6>
                                                    
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <span>Brüt Maaş:</span>
                                                        <span class="fw-bold text-success" id="grossSalary">₺0,00</span>
                                                    </div>
                                                    
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span>Net Maaş:</span>
                                                        <span class="fw-bold text-primary fs-5" id="netSalary">₺0,00</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a asp-action="Index" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Geri Dön
                                    </a>
                                    <div>
                                        <button type="button" class="btn btn-warning me-2" onclick="resetForm()">
                                            <i class="fas fa-undo me-2"></i>Temizle
                                        </button>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save me-2"></i>Bordroyu Oluştur
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            // Sayfa yüklendiğinde hesapla
            calculateSalary();
            
            // İnput değişikliklerinde hesapla
            $('#basicSalary, #allowances, #deductions').on('input', function() {
                calculateSalary();
            });
        });

        function calculateSalary() {
            var basicSalary = parseFloat($('#basicSalary').val()) || 0;
            var allowances = parseFloat($('#allowances').val()) || 0;
            var deductions = parseFloat($('#deductions').val()) || 0;
            
            var grossSalary = basicSalary + allowances;
            var netSalary = grossSalary - deductions;
            
            // Negatif net maaş kontrolü
            if (netSalary < 0) {
                netSalary = 0;
                $('#netSalary').addClass('text-danger').removeClass('text-primary');
            } else {
                $('#netSalary').addClass('text-primary').removeClass('text-danger');
            }
            
            // Göster
            $('#grossSalary').text(formatCurrency(grossSalary));
            $('#netSalary').text(formatCurrency(netSalary));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(amount);
        }

        function resetForm() {
            if (confirm('Formu temizlemek istediğinizden emin misiniz?')) {
                document.getElementById('payrollForm').reset();
                calculateSalary();
            }
        }

        // Form submit öncesi kontrol
        $('#payrollForm').on('submit', function(e) {
            var netSalary = parseFloat($('#basicSalary').val() || 0) + parseFloat($('#allowances').val() || 0) - parseFloat($('#deductions').val() || 0);
            
            if (netSalary <= 0) {
                e.preventDefault();
                toastr.error('Net maaş sıfır veya negatif olamaz. Lütfen kesinti miktarını kontrol edin.');
                return false;
            }
        });
    </script>
}
